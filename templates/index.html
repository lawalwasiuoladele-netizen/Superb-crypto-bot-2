<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>Superb Bot Dashboard</title>
    <style>
      body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
      input { margin: 5px; padding: 5px; width: 250px; }
      button { margin: 5px; padding: 7px 15px; cursor: pointer; }
      #logs { background: #111; color: #0f0; height: 260px; overflow-y: scroll; padding: 10px; font-family: monospace; }
      #status { margin: 10px 0; font-weight: bold; }
      table { width: 100%; border-collapse: collapse; margin-top: 10px; }
      th, td { padding: 8px; border: 1px solid #ddd; text-align: left; }
      .debug-output { white-space: pre-wrap; font-family: monospace; background: #fff; padding: 8px; margin-top: 6px; display: none; border: 1px solid #ccc; }
      .error { color: #c00; font-weight: bold; }
    </style>
  </head>
  <body>
    <h2>ðŸš€ Superb Crypto Bot</h2>

    <div>
      <input placeholder="Account name" id="name1">
      <input placeholder="API Key" id="key1">
      <input placeholder="API Secret" id="secret1">
      <button onclick="addAccount()">Add account</button>
    </div>

    <div style="margin-top:10px;">
      <button onclick="start()">Start</button>
      <button onclick="stop()">Stop</button>
      <span id="status"></span>
    </div>

    <h3>Accounts</h3>
    <table id="accounts-table">
      <thead>
        <tr><th>#</th><th>Name</th><th>Key</th><th>Balance</th><th>Pos</th><th>Trade</th><th>Actions</th></tr>
      </thead>
      <tbody id="accounts-body"></tbody>
    </table>

    <h3>Trades (recent)</h3>
    <div id="trades"></div>

    <h3>Summary</h3>
    <div id="summary"></div>

    <h3>Live Logs</h3>
    <div id="logs">(logs will appear here)</div>

    <script>
      const logsEl = document.getElementById('logs');
      function appendLog(text){ logsEl.innerText += text + "\n"; logsEl.scrollTop = logsEl.scrollHeight; }

      // SSE logs
      let evt = new EventSource('/logs');
      evt.onmessage = (e) => { appendLog(e.data); };
      evt.onerror = (e) => { appendLog('âš ï¸ Log stream error or closed, attempting reconnect...'); evt.close(); setTimeout(()=>{ evt = new EventSource('/logs'); }, 2000); };

      async function refreshAll(){
        await Promise.all([refreshAccounts(), refreshTrades(), refreshSummary()]);
      }

      async function refreshAccounts(){
        const res = await fetch('/accounts_data');
        const data = await res.json();
        const tbody = document.getElementById('accounts-body');
        tbody.innerHTML = '';
        data.forEach((acc, idx) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${idx+1}</td>
            <td>${acc.name}</td>
            <td>${acc.key_masked || ''}</td>
            <td>${acc.balance || ''}</td>
            <td>${acc.position || ''}</td>
            <td>${acc.current_symbol ? (acc.current_symbol + ' @ ' + (acc.buy_price || '')) : ''}</td>
            <td>
              <button onclick="removeAccount(${idx})">Remove</button>
              <button onclick="toggleDebug(${idx})">Debug</button>
            </td>
          `;
          tbody.appendChild(tr);

          const debugRow = document.createElement('tr');
          const debugTd = document.createElement('td');
          debugTd.colSpan = 7;
          debugTd.innerHTML = `<div id='debug-${idx}' class='debug-output'></div>`;
          debugRow.appendChild(debugTd);
          tbody.appendChild(debugRow);

          if(acc.last_validation_error){
            const errTr = document.createElement('tr');
            errTr.innerHTML = `<td colspan='7' class='error'>Error: ${acc.last_validation_error}</td>`;
            tbody.appendChild(errTr);
          }
        });
      }

      async function toggleDebug(idx){
        const el = document.getElementById('debug-' + idx);
        if(!el) return;
        if(el.style.display === 'block'){
          el.style.display = 'none';
          el.innerText = '';
          return;
        }
        el.style.display = 'block';
        try {
          const res = await fetch(`/account_debug/${idx}`);
          const data = await res.json();
          el.innerText = JSON.stringify(data, null, 2);
        } catch (err) {
          el.innerText = 'Error fetching debug info: ' + err;
        }
      }

      async function addAccount(){
        const name = document.getElementById('name1').value;
        const key = document.getElementById('key1').value;
        const secret = document.getElementById('secret1').value;
        if(!key || !secret){ alert('Please provide API key and secret'); return; }
        let accounts = await (await fetch('/accounts_data')).json();
        accounts.push({ name, api_key: key, api_secret: secret });
        await fetch('/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ accounts })
        });
        refreshAccounts();
      }

      async function removeAccount(idx){
        const data = await (await fetch('/accounts_data')).json();
        data.splice(idx, 1);
        await fetch('/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ accounts: data })
        });
        refreshAccounts();
      }

      async function start(){
        await fetch('/start', { method: 'POST' });
        document.getElementById('status').innerText = 'Bot started';
      }

      async function stop(){
        await fetch('/stop', { method: 'POST' });
        document.getElementById('status').innerText = 'Bot stopped';
      }

      async function refreshTrades(){
        const res = await fetch('/trades.json');
        const trades = await res.json();
        const el = document.getElementById('trades');
        el.innerText = JSON.stringify(trades.slice(-5), null, 2);
      }

      async function refreshSummary(){
        const accounts = await (await fetch('/accounts_data')).json();
        const total = accounts.reduce((a,b)=>a+(b.balance||0),0);
        document.getElementById('summary').innerText = 'Total balance: ' + total.toFixed(2);
      }

      refreshAll();
      setInterval(refreshAll, 10000);
    </script>
  </body>
</html>
