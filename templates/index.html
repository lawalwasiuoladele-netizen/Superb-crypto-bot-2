<!DOCTYPE html>
<html>
<head>
  <title>Trading Bot Dashboard</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; background: #fff; color: #000; margin: 10px; }
    h1 { font-size: 1.5em; }
    h2 { margin-top: 20px; font-size: 1.2em; }
    pre { font-size: 14px; background: #f5f5f5; padding: 10px; border-radius: 6px; overflow-x: auto; }
    .account { margin-bottom: 12px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; background: #fafafa; }
    .pnl-pos { color: green; font-weight: bold; }
    .pnl-neg { color: red; font-weight: bold; }
    .pnl-zero { color: black; font-weight: bold; }
    .loading { color: #888; font-style: italic; }
    table { border-collapse: collapse; margin-top: 10px; width: 100%; font-size: 14px; }
    th, td { border: 1px solid #ccc; padding: 6px 8px; text-align: center; }
    th { background: #f0f0f0; }
    button { padding: 10px 16px; margin: 5px 0; border: none; border-radius: 6px; font-size: 15px; cursor: pointer; }
    form { display: inline-block; margin-right: 8px; }
    form button { background: #007bff; color: white; }
    form button:hover { background: #0056b3; }
    input[type="text"], input[type="password"] {
      padding: 6px; margin: 4px; border: 1px solid #ccc; border-radius: 4px;
      font-size: 14px; width: 200px;
    }
    /* ‚úÖ Mobile adjustments */
    @media (max-width: 600px) {
      body { font-size: 14px; }
      h1 { font-size: 1.3em; }
      h2 { font-size: 1.1em; }
      table, th, td { font-size: 12px; }
      .account { font-size: 13px; }
      button { width: 100%; margin-bottom: 10px; }
      form { display: block; margin-right: 0; }
      input[type="text"], input[type="password"] { width: 100%; }
      .table-wrapper { overflow-x: auto; }
    }
  </style>
  <script>
    async function refreshAccounts() {
      const res = await fetch("/accounts_data");
      const data = await res.json();
      let html = "";
      data.forEach(acc => {
        html += `<div class="account">
          <b>Account ${acc.index + 1}:</b> ${acc.key} | 
          <b>Last Balance:</b> ${Number(acc.balance || 0).toFixed(4)}<br/>`;
        if (acc.trade) {
          let pnlClass = "pnl-zero";
          if (acc.trade.pnl > 0) pnlClass = "pnl-pos";
          else if (acc.trade.pnl < 0) pnlClass = "pnl-neg";

          html += `<b>Trade:</b> ${acc.trade.symbol} | 
                   Buy: ${Number(acc.trade.buy_price).toFixed(4)} | 
                   Started: ${acc.trade.entry_time}<br/>
                   Current: ${acc.trade.current_price !== "N/A" ? Number(acc.trade.current_price).toFixed(4) : "N/A"} | 
                   PnL: <span class="${pnlClass}">${acc.trade.pnl.toFixed(2)}%</span>

                   <form method="POST" action="/remove_account">
                     <input type="hidden" name="index" value="${acc.index}">
                     <button type="submit" style="background:#dc3545;">Remove</button>
                   </form>`;
        } else {
          html += `<i>No open trade</i>
                   <form method="POST" action="/remove_account">
                     <input type="hidden" name="index" value="${acc.index}">
                     <button type="submit" style="background:#dc3545;">Remove</button>
                   </form>`;
        }
        html += "</div>";
      });
      document.getElementById("accounts").innerHTML = html;
    }

    async function refreshTrades() {
      const res = await fetch("/trades_data");
      const data = await res.json();
      let html = "<div class='table-wrapper'><table><tr><th>Account</th><th>Symbol</th><th>Buy</th><th>Sell</th><th>Entry</th><th>Exit</th><th>Hold (s)</th><th>PnL %</th></tr>";
      data.forEach(t => {
        let pnlClass = "pnl-zero";
        if (t.pnl_pct > 0) pnlClass = "pnl-pos";
        else if (t.pnl_pct < 0) pnlClass = "pnl-neg";

        html += `<tr>
          <td>${t.account}</td>
          <td>${t.symbol}</td>
          <td>${Number(t.buy_price).toFixed(4)}</td>
          <td>${Number(t.sell_price).toFixed(4)}</td>
          <td>${t.entry_time}</td>
          <td>${t.exit_time}</td>
          <td>${t.hold_seconds}</td>
          <td class="${pnlClass}">${t.pnl_pct.toFixed(2)}%</td>
        </tr>`;
      });
      html += "</table></div>";
      document.getElementById("trades").innerHTML = html;
    }

    async function refreshSummary() {
      const res = await fetch("/summary_data");
      const data = await res.json();
      let pnlClass = "pnl-zero";
      if (data.total_pnl > 0) pnlClass = "pnl-pos";
      else if (data.total_pnl < 0) pnlClass = "pnl-neg";

      let html = `<b>Total Trades:</b> ${data.total_trades} |
                  <b>Wins:</b> ${data.wins} |
                  <b>Losses:</b> ${data.losses}<br/>
                  <b>Total PnL:</b> <span class="${pnlClass}">${data.total_pnl.toFixed(2)}%</span>`;
      document.getElementById("summary").innerHTML = html;

      let accHtml = "<h3>Per Account</h3><div class='table-wrapper'><table><tr><th>Account</th><th>Trades</th><th>Wins</th><th>Losses</th><th>Total PnL</th></tr>";
      for (const [acc, s] of Object.entries(data.accounts)) {
        let accClass = "pnl-zero";
        if (s.total_pnl > 0) accClass = "pnl-pos";
        else if (s.total_pnl < 0) accClass = "pnl-neg";
        accHtml += `<tr>
          <td>${acc}</td>
          <td>${s.trades}</td>
          <td>${s.wins}</td>
          <td>${s.losses}</td>
          <td class="${accClass}">${s.total_pnl.toFixed(2)}%</td>
        </tr>`;
      }
      accHtml += "</table></div>";
      document.getElementById("summary_accounts").innerHTML = accHtml;
    }

    function startIntervals() {
      setInterval(() => { if (document.getElementById("autoRefresh").checked) refreshAccounts(); }, 8000);
      setInterval(() => { if (document.getElementById("autoRefresh").checked) refreshTrades(); }, 15000);
      setInterval(() => { if (document.getElementById("autoRefresh").checked) refreshSummary(); }, 30000);
    }

    window.onload = function() {
      refreshAccounts();
      refreshTrades();
      refreshSummary();
      startIntervals();
    };
  </script>
</head>
<body>
  <h1>ü§ñ Trading Bot Dashboard</h1>

  {% if running %}
    <form method="POST" action="/stop"><button type="submit">Stop Bot</button></form>
  {% else %}
    <form method="POST" action="/start"><button type="submit">Start Bot</button></form>
  {% endif %}

  <div>
    <label><input type="checkbox" id="autoRefresh" checked> Auto-refresh</label>
  </div>

  <!-- ‚úÖ Add Account -->
  <h2>Add Account</h2>
  <form method="POST" action="/add_account">
    <input type="text" name="key" placeholder="API Key" required>
    <input type="password" name="secret" placeholder="API Secret" required>
    <button type="submit">Add Account</button>
  </form>

  <h2>Connected Accounts</h2>
  <div id="accounts" class="loading">‚è≥ Loading accounts...</div>

  <h2>Past Trades</h2>
  <div id="trades" class="loading">‚è≥ Loading trades...</div>

  <h2>Profit Summary</h2>
  <div id="summary" class="loading">‚è≥ Loading summary...</div>
  <div id="summary_accounts"></div>

  <h2>Bot Logs</h2>
  <pre id="logBox" class="loading">‚è≥ Connecting to logs...</pre>

  <script>
    const logBox = document.getElementById("logBox");
    const evtSource = new EventSource("/stream");
    evtSource.onmessage = function(event) {
      if (logBox.classList.contains("loading")) logBox.classList.remove("loading");
      logBox.innerText += event.data + "\n";
      if (logBox.innerText.split("\n").length > 200) {
        logBox.innerText = logBox.innerText.split("\n").slice(-200).join("\n");
      }
      logBox.scrollTop = logBox.scrollHeight;
    };
  </script>
</body>
</html>
