<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>Superb Bot Dashboard</title>
    <style>
      body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
      input { margin: 5px; padding: 5px; width: 250px; }
      button { margin: 5px; padding: 7px 15px; cursor: pointer; }
      #logs { background: #111; color: #0f0; height: 260px; overflow-y: scroll; padding: 10px; font-family: monospace; }
      #status { margin: 10px 0; font-weight: bold; }
      table { width: 100%; border-collapse: collapse; margin-top: 10px; }
      th, td { padding: 8px; border: 1px solid #ddd; text-align: left; }
      .debug-output { white-space: pre-wrap; font-family: monospace; background: #fff; padding: 8px; margin-top: 6px; display: none; border: 1px solid #ccc; }
      .error { color: #c00; font-weight: bold; }
    </style>
  </head>
  <body>
    <h2>ðŸš€ Superb Crypto Bot</h2>

    <div>
      <input placeholder="Account name" id="name1">
      <input placeholder="API Key" id="key1">
      <input placeholder="API Secret" id="secret1">
      <button onclick="addAccount()">Add account</button>
    </div>

    <div style="margin-top:10px;">
      <button onclick="start()">Start</button>
      <button onclick="stop()">Stop</button>
      <span id="status"></span>
    </div>

    <h3>Accounts</h3>
    <table id="accounts-table">
      <thead>
        <tr><th>#</th><th>Name</th><th>Key</th><th>Balance</th><th>Pos</th><th>Trade</th><th>Actions</th></tr>
      </thead>
      <tbody id="accounts-body"></tbody>
    </table>

    <h3>Trades (recent)</h3>
    <div id="trades"></div>

    <h3>Summary</h3>
    <div id="summary"></div>

    <h3>Live Logs</h3>
    <div id="logs">(logs will appear here)</div>

    <script>
      const logsEl = document.getElementById('logs');
      function appendLog(text){ logsEl.innerText += text + "\n"; logsEl.scrollTop = logsEl.scrollHeight; }

      // SSE logs
      let evt = new EventSource('/logs');
      evt.onmessage = (e) => { appendLog(e.data); };
      evt.onerror = (e) => { appendLog('âš ï¸ Log stream error or closed, attempting reconnect...'); evt.close(); setTimeout(()=>{ evt = new EventSource('/logs'); }, 2000); };

      async function refreshAll(){
        await Promise.all([refreshAccounts(), refreshTrades(), refreshSummary()]);
      }

      async function refreshAccounts(){
        const res = await fetch('/accounts_data');
        const data = await res.json();
        const tbody = document.getElementById('accounts-body');
        tbody.innerHTML = '';
        data.forEach(acc => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${acc.index+1}</td>
            <td>${acc.name}</td>
            <td>${acc.key}</td>
            <td>${acc.balance}</td>
            <td>${acc.pos}</td>
            <td>${acc.trade? (acc.trade.symbol + ' @ ' + acc.trade.buy_price) : ''}</td>
            <td>
              <button onclick="removeAccount(${acc.index})">Remove</button>
              <button onclick="toggleDebug(${acc.index})">Debug</button>
            </td>
          `;
          tbody.appendChild(tr);

          // debug row
          const debugRow = document.createElement('tr');
          const debugTd = document.createElement('td');
          debugTd.colSpan = 7;
          debugTd.innerHTML = `<div id='debug-${acc.index}' class='debug-output'></div>`;
          debugRow.appendChild(debugTd);
          tbody.appendChild(debugRow);

          // show inline last_error if present
          if(acc.last_error){
            const errTr = document.createElement('tr');
            errTr.innerHTML = `<td colspan='7' class='error'>Error: ${acc.last_error}</td>`;
            tbody.appendChild(errTr);
          }
        });
      }

      async function toggleDebug(idx){
        const el = document.getElementById('debug-' + idx);
        if(!el) return;
        if(el.style.display === 'block'){
          el.style.display = 'none';
          el.innerText = '';
          return;
        }
        el.style.display = 'block';
        el.innerText = 'Fetching debug info...';
        try{
          const res = await fetch(`/account_debug/${idx}`);
          const json = await res.json();
          el.innerText = JSON.stringify(json, null, 2);
        }catch(e){
          el.innerText = 'Debug fetch failed: ' + e;
        }
      }

      async function addAccount(){
        const name = document.getElementById('name1').value;
        const key = document.getElementById('key1').value;
        const secret = document.getElementById('secret1').value;
        if(!key || !secret){ alert('Please fill key and secret'); return; }
        const res = await fetch('/add_account', {method:'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({name, key, secret})});
        const j = await res.json();
        document.getElementById('status').innerText = j.status || 'ok';
        setTimeout(refreshAccounts, 500);
      }

      async function removeAccount(idx){
        await fetch('/remove_account', {method:'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({index: idx})});
        setTimeout(refreshAccounts, 500);
      }

      async function start(){
        // If inputs filled, pass them to /start to replace accounts file; else start with saved accounts
        const name = document.getElementById('name1').value;
        const key = document.getElementById('key1').value;
        const secret = document.getElementById('secret1').value;
        let body = null;
        if(name && key && secret){ body = {accounts: [{name, key, secret}]}; }
        const res = await fetch('/start', {method:'POST', headers: {'Content-Type':'application/json'}, body: body?JSON.stringify(body):null});
        const j = await res.json();
        document.getElementById('status').innerText = 'âœ… ' + (j.status || 'started');
        setTimeout(refreshAll, 1000);
      }

      async function stop(){
        await fetch('/stop', {method:'POST'});
        document.getElementById('status').innerText = 'ðŸ›‘ Bot stopping...';
      }

      async function refreshTrades(){
        const res = await fetch('/trades_data');
        const data = await res.json();
        const el = document.getElementById('trades');
        if(!data || data.length === 0){ el.innerText = 'No trades yet.'; return; }
        let html = '<table><tr><th>Acct</th><th>Symbol</th><th>Entry</th><th>Exit</th><th>%</th><th>Entry</th><th>Exit Time</th></tr>';
        data.slice().reverse().slice(0, 50).forEach(t => {
          html += `<tr><td>${t.account}</td><td>${t.symbol}</td><td>${t.entry_price || ''}</td><td>${t.exit_price || ''}</td><td>${(t.profit_pct!==undefined?t.profit_pct:(t.pnl_pct||''))}</td><td>${t.entry_time||''}</td><td>${t.exit_time||''}</td></tr>`;
        });
        html += '</table>';
        el.innerHTML = html;
      }

      async function refreshSummary(){
        const res = await fetch('/summary_data');
        const s = await res.json();
        const el = document.getElementById('summary');
        el.innerHTML = `<div>Total trades: ${s.total_trades}</div><div>Wins: ${s.wins} Losses: ${s.losses}</div><div>Total PnL: ${s.total_pnl}</div>`;
      }

      // initial
      refreshAll();
      setInterval(refreshAll, 15000);
    </script>
  </body>
</html>
